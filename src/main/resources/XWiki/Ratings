<?xml version="1.0" encoding="ISO-8859-1"?>

<xwikidoc>
<web>XWiki</web>
<name>Ratings</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1223390115000</creationDate>
<date>1227171629000</date>
<contentUpdateDate>1227171629000</contentUpdateDate>
<version>15.1</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/1.0</syntaxId>
<attachment>
<filename>star.gif</filename>
<filesize>1120</filesize>
<author>XWiki.Admin</author>
<date>1223392182000</date>
<version>1.1</version>
<comment></comment>
<content>R0lGODlhGQBLAOYAAPWGNf784eTi49TR0f3ANvu+bf/MmfPy8uPg4filTv7dSvzGcvioT/3guvu0Tuvq6/7xYfq5af7mif3LXP////7w3d/e3vidQfTz9P3ixP/nnP7kUv7ncf/MM/7+9fm1gv7Uaf3GWf76xOvq6tfV1f75sf7WSvmtSv7Zef3v5f7PQ/7vlPaSOv7ngv7emPnAmf748/7tptvY2f7oWf/MZv7fUfzYpv7uw/ilRf7XQ/7vuP70Y/7JPvu3T+fm5vmvU/712PqyTP738v7Xc/73nP72gP7hZff39+/v7/aPOf/elP/fefeUQv7sXfy8U/ioWPq/df3kzv7FO/7UUf70bP756P786v76uv73k/7dh//QO/7yq/7iav3kvf743PvVrP7wzf7uv/7ql/8zAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEHAGMALAAAAAAZAEsAAAf/gBSCg4SFhoeHR4qIjIRHSCM+GI2NGAgUlkeUiA8Pgj5Im4ZHFpqCFgemohQPFoRIMg8Ys4uJjzKhhBYyvDIII5ODRwcPCCQyPps+I6ZHxbKrFMvCktGsFsGCDwLRlgeFzgiqjEcy34cH5pQyI43p54i4lCO5iNONSPWHSOKND/DxxoGrNsiHhQeqBAh0hCDYCHaQLAiY5GOhsIlHBEwUhsQHKIuDOn4cVYtcSWsoU6oUdhLlIwEVV2JApREkpU6CSOhbRepIGCBIsKFsVaWDChgIGtp0BAuJBi1alhw55uNBPgzjFB0YYWHAABgmcojVMewAsQcjKTyyYOFjFQli/+Ny4SIhhgdWCAVl1ORFDBcFgAMDrkEYCAVU1DS1CEyY8IbHj1dQEAAQkwAkHjjUECtFCoHPUlRwmLxT0AGJHlB0Xq2i9RQYNRGRurSktYnbt41QGFCaULoRMRQ0rjGjuBUEvakd2FK8SRMI0CGIwElOEhHoVEpcKbJjR4nTNkkdwLIDi4cDoQKUCHA4fCkP7A0KaGuKGTluFE4jUfSoKobkIWHQSWX8LaUWfyslqOCC0SC4kjMC5KUSEqnIk9IRl1AQlIH7+JDCC0LEwqEj2HwAwAflyDILVuRg4AMJMCQhYxQ+DNDLQQINUwwJJBxgABNAPpGCaWZ1ogqE0KTwRb0CF1yAw5M4RABFA2rFpFcuBjAAJQ4ndHlCEGDaMBlAR9j3g5dfngClAw4sAFtpGFxWQQEXyAgAADLKyABsCqEjkRBPsCBok03ikMEIPZLDFgxaPtllED104UM/jCAxAAVsOuCEEyF06sKG7pBAQacTlGrqEBTIkM0hllBQKgg3UACGCxOAIM2qhrhIQRYueABLRR5UgQmuhRyQjCBJjcCVBaGY1cgj1yDEHyRpMbLVCKmA05ItIzLo7beCBAIAOw==</content>
</attachment>
<attachment>
<filename>smallstar.gif</filename>
<filesize>891</filesize>
<author>XWiki.Admin</author>
<date>1223394833000</date>
<version>1.1</version>
<comment></comment>
<content>R0lGODlhFAA8AOYAAOfm5vTz9OTi4/Py8tvY2ePg4filRevq6v7dSv7fUf3LXPaPOfmtSv7XQ/7xYf7oWf3GWf7489fV1f7kUv7WSvu0TvqyTP7FO/7+9f7PQ/m1gv7tpvidQf/fef7iav756P70Y/3v5f3ANtTR0fWGNf738v7sXfzGcv/nnPilTv/MM/7hZf7uv//Mmf7ngv743P7yq/72gP7wzf7w3f7vlP7UafmvU/ioT/7ql/7ncfvVrP3guvq/df/QO/712P7emP76uv7mifu3T/3kzv70bPzYpv784fy8U/73nN/e3uvq6+/v7/f39////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAAAAAAALAAAAAAUADwAAAf/gE2Cg4SFhodMTIeLggEFTQWKjIVKSk0AS5OETEmSSQOSk0pJg0sESgEBiYQDSgUSAJMAkkwFqJqXg0wBuE2jhAK4jgOFAwTEhwQHi8aLBJmLy4cA0ofQhkuRiLGDSUqSAqGbj00HzwdJwbOI4QICvE1MS5jihPNL9au9+/yM+vzywvWr1ETCNU2cmLBYkgSeplEfVEQoUMDhIibPUPTowETCqSVLHHJKgulDkAYoG3jwsAGDL1qKXuBAQLMmggQJfDQhJWiVC5o4E0wYOoFGEwHIBAlYgiEHygsXRIi4kOHowZ5JCnTIkIGCVworRlwdZGzDTZwP0hYY2xMAjLQm2BzIdUBwGxK5RIDEAAFiQCdESTAYuSSApKID9XoG84tPHoAAbAUtqZQ03j9DiRL328x5k+ZJTCp9RvSI4ehC80KUOHUaawANGjCiSqWZCQAJERYsGAJgBAEC3ggpEYAqhI4UHAwoN8Bjh+VSglosN8CgugULRY4SQtzERnUGFpZXOBFhKaEAS2dw0E1Ct+7yAgtxinBDuXUhALRZa1Kh/xEIAJrGTBMAKmCggU0QYNF5TRhYQxMy/KDAJQuSNUgBB6BDygCVbeKLN5ndM1qGoHgGWmudpShIIAA7</content>
</attachment>
<object>
<class>
<name>XWiki.JavaScriptExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>onDemand=On demand|always=Always</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>XWiki.Ratings</name>
<number>0</number>
<className>XWiki.JavaScriptExtension</className>
<property>
<cache>forbid</cache>
</property>
<property>
<code>function setVote(ulel, url, i) 
{
 return function() 
 {
   url = url + "&amp;vote=" + i; 
   new Ajax.Request(url, 
   {
    method: 'get',
    onSuccess: function(transport)
    {
      var values = transport.responseText.split("-");
      var avgvote = values[0];
      var uservote = values[1];
      var nbvotes = values[2];

      if( (avgvote = parseFloat(avgvote)) ) {
        var w = avgvote * 20;
        ulel.down("li.current-rating").style.width = w + "%";
      }
      else alert(transport.responseText); //TODO proper error handling

      var id = ulel.up('.rating-container').id;

      if( (uservote = parseInt(uservote)) ) {
        var w = uservote * 20;
        $(id + "-user").down('.star-rating').down("li.current-rating").style.width = w + "%";
      }
      else alert(transport.responseText); //TODO proper error handling

      $(id).down('.rating-message').down('span').innerHTML = nbvotes;
    }
   });
 }
}

function showMsg(msgdiv, i) 
{
 return function() 
 {
   var msgs = ["$msg.get("rating.one-star")", "$msg.get("rating.two-stars")", "$msg.get("rating.three-stars")", "$msg.get("rating.four-stars")", "$msg.get("rating.five-stars")"];
   msgdiv.update(msgs[i]);
 }
}

function hideMsg(msgdiv, prevmsg) 
{
 return function() 
 {
   msgdiv.update(prevmsg);
 }
}

function injectRatingsCategory() {
  Element.insert($("admin-icons"), {bottom: "&lt;li class='Ratings'&gt;&lt;a href=\"$xwiki.getURL('XWiki.XWikiPreferences','admin','editor=globaladmin&amp;section=Ratings')\"&gt;Ratings&lt;/a&gt;&lt;/li&gt;"});
}

Event.observe(window, 'load', function() 
{ 
  if ($("admin-icons")) {  // In administration
      injectRatingsCategory();
  }
 
  else {

   // This is a hack to find out which is the current document rendered.
   // We cannot rely on velocity $doc since JSX are rendered in their own request, 
   // thus in the context of their own document.
   // I choose to extract the document full name from the print menu "export as XAR" URL, as it is always available
   // (even when not authenticated).
   // In the future we will have to define and add a convention in the HTML of a wikidoment to retrieve the document
   // more easily and more reliably. 
   var ptEntries = $('tmPrint').select('.submenuitem');
   ptHref = ptEntries[ptEntries.length-1].down().href;
   var docFullName = ptHref.substring(ptHref.indexOf("&amp;pages") + 7);
   var docSpace = docFullName.substring(0, docFullName.indexOf('.'));

   if(docSpace != "XWiki") {

     var url = "$xwiki.getURL('XWiki.Ratings', 'view', 'xpage=plain')" + "&amp;rating=" + docFullName;
     new Ajax.Request(url, {
     method: 'get',
     onSuccess: function(transport)
     {
        if ($('breadcrumbs')) {
          Element.insert($('breadcrumbs'), {after: transport.responseText});
        }
        $$('.star-rating').each(function(el) 
        {
           if(! el.hasClassName('locked')) 
           {
              var url = "$xwiki.getURL("XWiki.Ratings", "view", "xpage=plain")" + "&amp;doc=" + el.up('.rating-wrapper').id.substring(7);
              var msgdiv = el.up('.rating-container').down('.rating-message');

              el.select('a').each(function(astar, i) 
              {  
                  Event.observe(astar, 'click', setVote(el, url, i + 1));
                  var prevmsg = msgdiv.innerHTML;
                  Event.observe(astar, 'mouseover', showMsg(msgdiv, i));
                  Event.observe(astar, 'mouseout', hideMsg(msgdiv, prevmsg));
              }); // container 
           }
        }); 
      } // onSuccess
    });
  } // docSpace
 } // Not administration
});</code>
</property>
<property>
<name>Ratings Javascript</name>
</property>
<property>
<parse>1</parse>
</property>
<property>
<use>always</use>
</property>
</object>
<object>
<class>
<name>XWiki.RatingsClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<author>
<name>author</name>
<number>1</number>
<prettyName>Author</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</author>
<date>
<dateFormat>dd/MM/yyyy HH:mm:ss</dateFormat>
<emptyIsToday>1</emptyIsToday>
<name>date</name>
<number>3</number>
<picker>1</picker>
<prettyName>Date</prettyName>
<size>20</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.DateClass</classType>
</date>
<parent>
<name>parent</name>
<number>4</number>
<prettyName>Parent</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</parent>
<vote>
<name>vote</name>
<number>2</number>
<numberType>integer</numberType>
<prettyName>Vote</prettyName>
<size>5</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.NumberClass</classType>
</vote>
</class>
<name>XWiki.Ratings</name>
<number>0</number>
<className>XWiki.RatingsClass</className>
<property>
<author>XWiki.Admin</author>
</property>
<property>
<date>2008-11-04 12:58:26.0</date>
</property>
<property>
<parent>XWiki.Ratings</parent>
</property>
<property>
<vote>3</vote>
</property>
</object>
<object>
<class>
<name>XWiki.StyleSheetExtension</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<cache>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>cache</name>
<number>5</number>
<prettyName>Caching policy</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>long|short|default|forbid</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</cache>
<code>
<name>code</name>
<number>2</number>
<prettyName>Code</prettyName>
<rows>20</rows>
<size>50</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
</code>
<name>
<name>name</name>
<number>1</number>
<prettyName>Name</prettyName>
<size>30</size>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.StringClass</classType>
</name>
<parse>
<displayFormType>select</displayFormType>
<displayType>yesno</displayType>
<name>parse</name>
<number>4</number>
<prettyName>Parse content</prettyName>
<unmodifiable>0</unmodifiable>
<classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
</parse>
<use>
<cache>0</cache>
<displayType>select</displayType>
<multiSelect>0</multiSelect>
<name>use</name>
<number>3</number>
<prettyName>Use this extension</prettyName>
<relationalStorage>0</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>1</size>
<unmodifiable>0</unmodifiable>
<values>onDemand=On demand|always=Always</values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</use>
</class>
<name>XWiki.Ratings</name>
<number>0</number>
<className>XWiki.StyleSheetExtension</className>
<property>
<cache>default</cache>
</property>
<property>
<code>/* administration */
#admin-icons li a {
background-position:50% 0;
background-repeat:no-repeat;
color:#808085;
display:block;
font-weight:bold;
padding-top:87px;
width:124px;
}

/* ratings */
.star-rating,
.star-rating a:hover,
.star-rating a:active,
.star-rating a:focus,
.star-rating .current-rating{
background: url($doc.getAttachmentURL("star.gif")) left -1000px repeat-x;
}
.star-rating{
position:relative;
width:125px;
height:25px;
overflow:hidden;
list-style:none;
margin:0px !important;
padding:0px !important;
background-position: left top;
}
.star-rating li{
display: inline;
}
.star-rating a,
.star-rating .current-rating{
position:absolute;
top:0;
left:0;
text-indent:-1000em;
height:25px;
line-height:25px;
outline:none;
overflow:hidden;
border: none;
}
.star-rating a:hover,
.star-rating a:active,
.star-rating a:focus{
background-position: left bottom;
}
.star-rating a.one-star{
width:20%;
z-index:6;
}
.star-rating a.two-stars{
width:40%;
z-index:5;
}
.star-rating a.three-stars{
width:60%;
z-index:4;
}
.star-rating a.four-stars{
width:80%;
z-index:3;
}
.star-rating a.five-stars{
width:100%;
z-index:2;
}
.star-rating .current-rating{
z-index:1;
background-position: left center;
}

.small-star{
width:100px;
height:20px;
}

.small-star,
.small-star a:hover,
.small-star a:active,
.small-star a:focus,
.small-star .current-rating{
background-image: url($doc.getAttachmentURL("smallstar.gif"));
line-height: 20px;
height: 20px;
}

ul.locked a,
ul.locked a:hover,
ul.locked a:active,
ul.locked a:focus {
background: transparent none;
}

ul.locked a {
cursor: default !important;
}

.rating-container {
display: block; 
clear: both; 
float: none;
height: 25px;
line-height: 25px;
}

.rating-header, .rating-stars, .rating-message {
display: inline;  
float: right;
clear: none;
}

.rating-header {
font-size: 11px;
font-weight: bold;
margin-right: 2px;
height: 25px;
line-height: 25px;
}

.rating-message {
font-size: 10px;
color: #333;
font-style: italic;
right: 5px;
position: relative;
}

.login-to-rate {
font-size: 11px;
font-weight: bold;
}

.small {
height: 20px !important;
line-height: 20px !important;
}

.rating-wrapper {
float: left;
width: 50%;
right: 30px;
position: relative;
}

#breadcrumbs {
width: 50%;
float: left;
}</code>
</property>
<property>
<name>Ratings CSS</name>
</property>
<property>
<parse>1</parse>
</property>
<property>
<use>always</use>
</property>
</object>
<object>
<class>
<name>XWiki.TagClass</name>
<customClass></customClass>
<customMapping></customMapping>
<defaultViewSheet></defaultViewSheet>
<defaultEditSheet></defaultEditSheet>
<defaultWeb></defaultWeb>
<nameField></nameField>
<validationScript></validationScript>
<tags>
<cache>0</cache>
<displayType>input</displayType>
<multiSelect>1</multiSelect>
<name>tags</name>
<number>1</number>
<prettyName>Tags</prettyName>
<relationalStorage>1</relationalStorage>
<separator> </separator>
<separators> ,|</separators>
<size>30</size>
<unmodifiable>0</unmodifiable>
<values></values>
<classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
</tags>
</class>
<name>XWiki.Ratings</name>
<number>0</number>
<className>XWiki.TagClass</className>
<property>
<tags/>
</property>
</object>
<content>#if("$!{request.xpage}" == "plain")
  #if("$!{request.vote}" != "")
    #set($rdoc = $xwiki.getDocument($request.doc))
    #set($vote = $xwiki.parseInt($request.vote))
    #if($vote &gt; 0 &amp;&amp; $vote &lt;= 5)
      #set($ok = $xwiki.ratings.setRating($rdoc, $context.user, $vote))
      #if($ok) 
        #if("$!{request.method}" != "")
          #set($ar = $xwiki.ratings.getAverageRating($rdoc, $request.method))
        #else
          #set($ar = $xwiki.ratings.getAverageRating($rdoc))
        #end
        #set($avgvote = $ar.averageVote)
        #set($uservote = $xwiki.ratings.getRating($rdoc, $context.user))
        #set($nbVotes = $ar.nbVotes)
        ${avgvote}-${uservote.vote}-${nbVotes}
      #else 
        $msg.get("rating.saveexception")
      #end
    #elseif($vote == 0)
      $msg.get("rating.votenotvalid")
    #else
      $msg.get("rating.voteoutofbounds")
    #end
  #elseif("${request.rating}" != "")
    #includeMacros("XWiki.RatingsMacros")
    #set($ratedDoc=$xwiki.getDocument("$request.rating"))
    #displayFullRating($ratedDoc "")
  #end
#end</content>
</xwikidoc>
